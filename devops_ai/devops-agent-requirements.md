# DevOps AI Agent 对话式功能分析

<aside>

本文已按「先给分析计划 → 用户确认 → 调度子 Agent → 流式输出」主线整理。以下加入一段可速读的执行摘要与检查清单，便于值班快速对齐。

</aside>

### 执行摘要（TL;DR）

- 交互原则：先产出「分析/执行计划」，需用户明确确认后再调度日志/指标/执行子 Agent。
- 关键输入：服务、环境、时间窗口、数据源可用性。缺失时由 Agent 追问补齐。
- 关键输出：问题摘要、影响范围、指标趋势文字化、典型日志片段、建议修复动作。
- 风控要求：一切变更先 dry-run，需用户以明确语句确认实操；给出回滚与观察建议。
- 扩展组件：ActionPlan/Report/Execution 子 Agent 已就位，可按照“上下文确认 → 计划/报告 → 修复/验证”顺序编排，保留原有 SSE 流式体验。

### 最小可用流程（MVP）

1. 计划协商：生成计划草案 → 用户确认或修改
2. 并行分析：日志 Agent 与指标 Agent 并发，过程流式回报
3. 结果讲解：按计划条目逐条输出证据与结论
4. 修复闭环：修复计划 → 确认 → dry-run → 二次确认 → 实操
5. 审计导出：生成可追踪记录与链接

### 值班检查清单

- [ ]  指定服务与环境（如：checkout, production）
- [ ]  明确时间窗口（如：最近 15 分钟）
- [ ]  选择数据源（prod-logging, Prometheus prod）
- [ ]  确认是否仅看日志或同时看指标
- [ ]  是否允许 dry-run 后继续实操

---

本文聚焦「用户对话方式」下的功能需求,描述值班工程师如何通过自然语言与 Agent 沟通,完成日志与指标分析、诊断确认以及修复命令执行。

## 对话目标

- 工程师无需了解底层 API,只需以自然语言描述问题或请求诊断。
- Agent 在对话中主动追问必要上下文(时间范围、系统/服务、严重性)。
- 诊断结果与修复建议以易懂、结构化的语言返回,并支持继续追问细节。

## 角色与意图

- **用户(值班工程师)**:通过聊天界面提交问题、请求诊断/执行动作、确认或拒绝操作。
- **DevOps AI Agent**:解析意图、补齐上下文、调用日志/指标工具、生成诊断、提示修复方案并记录交互。

## 关键对话流

### 1. 采集与上下文确认

1. 用户描述问题:如"来自 checkout 服务的 500 错误突然很多"。
2. Agent 追问所需上下文:时间窗口、环境、是否已有告警编号等。
3. 若缺少数据源配置,Agent 引导用户提供日志/指标端点或选择已有配置。

### 2. 触发诊断

1. 用户请求:"帮我分析最近 15 分钟的 checkout 服务日志和指标"。
2. Agent 将自然语言映射为诊断参数:数据源 ID、时间范围、阈值策略。
3. Agent 回应诊断开始,并在后台协调日志/指标 Tool,实时在对话中报告进度(如"正在获取日志…")。

### 3. 诊断结果讲解

1. Agent 以对话形式总结发现:
    - 问题摘要、影响范围、关键指标与日志片段。
    - 优先级、建议操作以及关联证据位置。
2. 用户可继续提问细节("有哪些典型日志?"),Agent 提供原始片段或图表描述。

### 4. 修复动作协商

1. Agent 基于诊断列出候选修复动作("可重启 checkout pod,或回滚配置")。
2. 用户确认具体动作和执行模式(实操/干跑)。
3. Agent 在对话中展示命令预览、需要的审批令牌,并等待明确的"确认执行"回复。
4. 执行完成后,Agent 回报输出结果、状态和回滚提示;若失败会引导下一步调查。

### 5. 审计与导出

1. 用户可请求"导出这次诊断和执行记录"。
2. Agent 告知已生成的记录位置或下载链接,并在对话中给出追踪 ID。

## 对话式体验要点

- **状态记忆**:Agent 在单次会话内记住已确认的服务、时间范围和诊断 ID,避免重复提问。
- **术语翻译**:对于复杂的指标/日志字段,Agent 用自然语言解释含义,并在需要时附原始名称。
- **容错提示**:当缺少数据或规则无法匹配时,Agent 用对话指导用户补齐信息,而非直接失败。
- **安全确认**:执行任何命令前都需用户以明确语句确认(如"确认重启 prod-checkout"),同时提示可能影响。

## 示例对话片段

> 用户:checkout 服务 500 错误暴涨,帮我看看最近 15 分钟的情况。
>

> Agent:明白,确认环境是 production 吗?需要同时查看 CPU/错误率指标吗?
>

> 用户:是 production,也查下 CPU。
>

> Agent:已调取 prod-checkout 日志与 prometheus 指标……发现 12:05 开始 ERROR 日志激增 300%,CPU 峰值 95%。建议执行:重启 checkout-worker,或扩容副本。需要我准备重启命令吗?
>

> 用户:先重启一个副本,干跑看看。
>

> Agent:好的,将执行 `kubectl rollout restart deploy/checkout-worker`(dry-run)。请确认。
>

> 用户:确认。
>

> Agent:干跑成功,命令输出如下……需要实操执行吗?
>

以上分析覆盖了对话式场景下的核心功能期望,可作为实现日志分析 Agent 时的交互基准。

---

## **对话目标**

- 工程师无需了解底层 API，只需以自然语言描述问题或请求诊断。
- Agent 在对话中**先产出一个清晰的分析/执行计划**，说明要做什么、用哪些数据源、产出哪些结果。
- 用户**显式确认分析计划**后，Agent 才根据该计划调用日志/指标/执行等子 Agent，并以流式方式输出过程与结果。
- 诊断结果与修复建议以易懂、结构化的语言返回，并支持继续追问细节或调整计划。

---

## **角色与意图**

- **用户（值班工程师）**
    - 通过聊天界面提交问题、请求诊断/执行动作、确认或拒绝操作。
    - 对 Agent 给出的分析/执行计划进行确认、修改或追加约束。
- **DevOps AI 主 Agent**
    - 解析用户意图，补齐上下文。
    - 生成「分析/执行计划」（包含要查询的数据源、时间窗口、分析步骤、预期输出等）。
    - 在用户确认后，按计划编排并调用日志/指标/告警/执行等子 Agent。
    - 负责聚合结果、生成可读的诊断说明与修复建议，并以**流式方式**输出过程与中间进展。
- **工具 / 子 Agent（Log/Metric/Action 等）**
    - **日志分析 Agent**：根据主 Agent 提供的参数，检索/聚合日志并返回结构化结果。
    - **指标分析 Agent**：查询监控指标（Prometheus 等）并进行异常检测。
    - **执行 Agent**：负责生成、校验并执行变更命令（如 kubectl、脚本），返回执行输出与状态。
    - **审计/记录 Agent**：整理本次会话中的关键操作、参数与结果，生成可追溯记录。

---

## **分析计划驱动的总体对话流程**

高层流程可以分为 5 个阶段，其中 **“0. 分析计划协商”** 是新增的核心步骤：

1. **分析计划协商**：主 Agent 基于用户描述生成计划草案 → 用户确认/修改。
2. **采集与上下文确认**：补充必要的上下文信息。
3. **触发诊断**：将自然语言意图映射为诊断任务并调度子 Agent。
4. **诊断结果讲解**：以对话形式解释发现、证据和建议。
5. **修复动作协商与执行**：同样通过「计划 → 确认 → 执行」闭环完成变更。
6. **审计与导出**：输出可追踪的记录。

下面按阶段展开。

---

## **0. 分析计划协商（新增重点）**

### **0.1 计划生成**

1. 用户给出问题描述，例如：

   > “checkout 服务 500 错误暴涨，帮我看看最近 15 分钟的情况。”
>
2. 主 Agent 基于当前会话信息，生成**分析计划草案**，例如：

```
初步分析计划如下，请确认是否按此执行：

1）范围与上下文
   - 服务：checkout
   - 环境：暂定为 production（如不正确请指出）
   - 时间窗口：最近 15 分钟

2）日志分析
   - 数据源：prod-logging（ELK）
   - 操作：
     - 过滤 checkout 的 5xx 日志
     - 按时间聚合错误数量，找出峰值时间段
     - 抽样 10 条典型错误日志（含 stack trace）

3）指标分析
   - 数据源：Prometheus prod
   - 操作：
     - 查询 checkout 的错误率、CPU、内存、QPS
     - 识别是否存在资源瓶颈或下游依赖异常

4）输出形式
   - 问题摘要 + 影响范围
   - 关键指标趋势描述（文字化）
   - 典型日志样例
   - 初步可能原因列表 + 建议下一步动作

请回复：
- “确认按计划执行”，我将开始调度日志/指标子 Agent，并以流式方式报告进度；
- 或指出需要修改的部分（例如环境、时间、数据源）。
```

### **0.2 用户确认与修改**

- 用户可以：
    - 直接确认（如：“确认按计划执行”）。
    - 局部修改（如：“环境改成 staging”，“时间改成最近一小时”）。
    - 要求简化或增强分析（如：“先只看日志，不看指标”）。

### **0.3 计划冻结与任务拆解**

- 主 Agent 在用户确认后，将计划“冻结”为本次诊断的上下文，生成内部任务列表，例如：
    - TASK_LOG_ANALYSIS
    - TASK_METRIC_ANALYSIS
    - TASK_ROOT_CAUSE_SUMMARY
- 再按任务列表依次/并行调用日志 Agent、指标 Agent 等，并**流式回报**执行状态与阶段性结果。

---

## **1. 采集与上下文确认**

在计划协商前后，主 Agent 都可能需要补充上下文信息：

1. 用户描述问题：如“来自 checkout 服务的 500 错误突然很多”。
2. Agent 追问必要上下文：时间窗口、环境、是否已有告警编号、数据源可用性等。
3. 若缺少数据源配置，Agent 引导用户：
    - 选择已有配置（如“prod-logging”）。
    - 或提供新的日志/指标端点。

这些信息将回写到分析计划中，避免后续重复询问。

---

## **2. 触发诊断（按计划调度子 Agent）**

在用户确认分析计划后，进入实际诊断阶段：

1. 主 Agent 将计划转换为具体诊断参数：数据源 ID、时间范围、过滤条件、阈值策略等。
2. 按任务拆解调用子 Agent：
    - 并行调用日志 Agent 与指标 Agent（适合用异步/并发模型）。
    - 每个子 Agent 完成后返回结构化结果（统计指标 + 典型样本）。
3. **流式输出体验**：
    - 在对话中持续更新进度，例如：
        - “正在获取 prod-checkout 最近 15 分钟的日志……”
        - “已完成日志聚合，正在分析错误模式……”
        - “已获取指标数据，CPU 峰值 95%，错误率显著上升……”
    - 避免长时间“黑箱等待”，让值班工程师对执行过程有可感知的反馈。

---

## **3. 诊断结果讲解（结构化 + 计划对齐）**

诊断完成后，主 Agent 需要结合计划，给出结果说明：

1. 针对分析计划中的每个子任务，对应产出摘要：
    - 问题摘要、影响范围（instance 数量、QPS 规模）。
    - 关键时间点（如“12:05 开始错误暴涨”）。
    - 关键指标与日志片段（文字描述 + 少量样例）。
2. 解释性输出：
    - 将复杂字段翻译为自然语言说明，例如：
        - http_server_requests_seconds_count → “HTTP 请求总次数”
    - 需要时，附上原始指标/字段名，方便工程师对照。
3. 保持与分析计划的一致性：
    - 标记每个输出对应计划中的哪一步。
    - 若某一步计划无法执行（如数据源不可用），要说明原因并给出替代建议。

用户可以继续追问细节（“列一下典型 5 条日志”），Agent 再补充原始片段或更细粒度的描述。

---

## **4. 修复动作协商与执行（同样采用计划 → 确认 → 执行）**

修复阶段也应采用“先计划、后确认、再执行”的模式。

1. **生成修复计划草案**
    - 基于诊断结果，Agent 列出可选修复动作：
        - 例如：“重启 checkout-worker 副本”、“临时扩容到 5 个副本”、“回滚至上一个稳定版本”。
    - 给出每个动作的影响预估与前置条件。
2. **用户确认修复计划**
    - 用户选择方案，例如：
        - “先重启一个副本，dry-run 一下。”
    - Agent 整理为修复计划：

```
修复计划：
1）环境：production
2）操作：对 deploy/checkout-worker 执行一次 rollout restart（先 dry-run）
3）风控：仅影响 1 个副本，若执行失败不做实操
4）后续：若 dry-run 成功，再询问是否执行实操

请回复“确认执行修复计划”继续。
```

1.
2. **执行与流式反馈**
    - 用户以明确语句确认（如：“确认执行修复计划”或“确认重启 prod-checkout 一个副本，dry-run”）。
    - 执行 Agent 按计划执行命令：
        - 先 dry-run → 返回命令预览与 dry-run 输出。
        - 再根据用户二次确认，执行真实变更。
    - 整个过程以流式方式反馈执行状态与结果。
3. **安全与回滚提示**
    - 在执行前提示可能影响：
        - 如“可能短暂影响 checkout 请求延迟”。
    - 执行后给出回滚建议或下一步观测动作（如“建议接下来 5 分钟持续观察错误率和延迟”）。

---

## **5. 审计与导出**

1. 主 Agent 将本次会话中关键内容结构化记录：
    - 问题描述、分析计划、实际调用的子 Agent、诊断结论、修复动作与结果。
2. 用户可请求：
    - “导出这次诊断和执行记录”。
3. Agent 返回：
    - 记录存放位置（如 Wiki/Issue/工单链接）。
    - 或直接提供下载链接/追踪 ID，便于值班交接与事后复盘。

---

## **示例对话片段（加入分析计划 & 流式输出）**

```
用户：checkout 服务 500 错误暴涨，帮我看看最近 15 分钟的情况。

Agent：
收到，我先给出一个分析计划，请你确认是否按此执行：

1）范围与上下文
   - 服务：checkout
   - 环境：production（如有误请更正）
   - 时间：最近 15 分钟

2）日志分析
   - 从 prod-logging 中筛选 checkout 的 5xx 日志
   - 按分钟聚合错误数，找出峰值时间段
   - 抽样 10 条典型错误日志（含 stack trace）

3）指标分析
   - 从 Prometheus 查询 checkout 的错误率、CPU、内存、QPS
   - 判断是否存在资源瓶颈或下游依赖异常

4）输出
   - 问题摘要 + 影响范围
   - 关键指标趋势文字描述
   - 典型日志样例
   - 初步可能原因 + 建议修复动作

请回复“确认按计划执行”，或说明需要调整的部分。

用户：确认按计划执行。

Agent：
好的，开始执行分析计划，将以流式方式汇报进度。

[流式输出片段示例]
- 正在获取 prod-checkout 最近 15 分钟的 5xx 日志……
- 已完成日志聚合，12:05 起错误数较基线提升约 300%……
- 正在查询 Prometheus 指标……
- 指标结果：12:05~12:10 间 CPU 峰值 95%，错误率显著上升，QPS 持平……

综合分析：
- 问题摘要：从 12:05 起，checkout 服务 5xx 错误显著升高，伴随 CPU 接近打满
- 可能原因：新版本引入的计算密集逻辑或循环重试；暂未发现下游依赖错误峰值同步上升
- 建议修复动作：
  1）重启部分 checkout-worker 副本，缓解个别实例异常状态
  2）短期扩容副本数，缓冲峰值流量

是否需要我基于上述建议生成“重启 1 个副本（先 dry-run）”的修复计划？
```

---
